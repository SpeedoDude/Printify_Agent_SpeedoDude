{% extends "base.html" %}

{% block title %}Order #{{ order.id }}{% endblock %}

{% block content %}
<h1>Order #{{ order.id }}</h1>
<div class="row">
    <div class="col-md-6">
        <h2>Order Details</h2>
        <p><strong>Status:</strong> <span id="orderStatus">{{ order.status }}</span></p>
        <p><strong>Total Price:</strong> ${{ order.total_price / 100 }}</p>
        <p><strong>Shipping Address:</strong></p>
        <address>
            {{ order.address_to.first_name }} {{ order.address_to.last_name }}<br>
            {{ order.address_to.address1 }}<br>
            {% if order.address_to.address2 %}
                {{ order.address_to.address2 }}<br>
            {% endif %}
            {{ order.address_to.city }}, {{ order.address_to.region }} {{ order.address_to.zip }}<br>
            {{ order.address_to.country }}
        </address>
    </div>
    <div class="col-md-6">
        <h2>Items</h2>
        <ul class="list-group">
            {% for item in order.line_items %}
            <li class="list-group-item">
                {{ item.quantity }}x {{ item.title }}
            </li>
            {% endfor %}
        </ul>
        {% if order.status == 'on-hold' %}
        <button id="fulfillOrder" class="btn btn-success mt-3">Fulfill Order</button>
        {% endif %}
    </div>
</div>

<script>
document.getElementById("fulfillOrder")?.addEventListener("click", () => {
    const orderId = "{{ order.id }}";
    fetch("/api/orders/fulfill", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ order_id: orderId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert("Order fulfilled successfully!");
            document.getElementById("orderStatus").textContent = "fulfilled";
            document.getElementById("fulfillOrder").style.display = "none";
        } else {
            alert("Error fulfilling order: " + data.error);
        }
    });
});
</script>
{% endblock %}
